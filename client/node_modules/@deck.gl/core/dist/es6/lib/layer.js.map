{"version":3,"sources":["../../../src/lib/layer.js"],"names":["COORDINATE_SYSTEM","AttributeManager","removeLayerInSeer","diffProps","count","log","GL","withParameters","assert","Component","LayerState","LOG_PRIORITY_UPDATE","EMPTY_ARRAY","Object","freeze","noop","defaultProps","data","type","value","async","dataComparator","dataTransform","fetch","url","then","response","json","updateTriggers","numInstances","undefined","visible","pickable","opacity","min","max","onHover","onClick","coordinateSystem","LNGLAT","coordinateOrigin","wrapLongitude","parameters","uniforms","framebuffer","animation","getPolygonOffset","layerIndex","highlightedObjectIndex","autoHighlight","highlightColor","Layer","toString","className","constructor","layerName","name","props","id","setState","updateObject","setChangeFlags","stateChanged","assign","state","setNeedsRedraw","redraw","internalState","needsRedraw","setLayerNeedsUpdate","context","layerManager","setNeedsUpdate","String","getNeedsRedraw","clearRedrawFlags","_getNeedsRedraw","needsUpdate","shouldUpdateState","_getUpdateParams","isPickable","getModels","models","model","getSingleModel","getAttributeManager","attributeManager","getCurrentLayer","layer","getFirstObject","object","project","lngLat","viewport","Array","isArray","unproject","xy","projectFlat","unprojectFlat","use64bitProjection","fp64","once","use64bitPositions","LNGLAT_EXPERIMENTAL","screenToDevicePixels","screenPixels","deprecated","devicePixelRatio","window","nullPickingColor","encodePickingColor","i","decodePickingColor","color","Uint8Array","i1","i2","i3","index","initializeState","Error","oldProps","changeFlags","propsOrDataChanged","updateState","dataChanged","invalidateAll","finalizeState","delete","finalize","draw","opts","getPickingInfo","info","mode","invalidateAttribute","diffReason","invalidate","updateAttributes","getNumInstances","update","transitions","buffers","ignoreUnknownAttributes","changedAttributes","getChangedAttributes","clearChangedFlags","setAttributes","updateTransition","calculateInstancePickingColors","attribute","size","pickingColor","_clearInstancePickingColor","instancePickingColors","attributes","forEach","_clearPickingColor","pickingColors","length","clearPickingColor","copyPickingColors","colors","Uint8ClampedArray","restorePickingColors","set","_initialize","gl","_initState","propsChanged","viewportChanged","_updateState","program","geometry","_update","stateNeedsUpdate","updateParams","isComposite","_renderLayers","_updateBaseUniforms","setInstanceCount","clearChangeFlags","resetOldProps","_finalize","drawLayer","moduleParameters","picking_uActive","setModuleParameters","animationProps","_setAnimationProps","offsets","polygonOffset","pickLayer","getChangeFlags","flags","updateTriggersChanged","keys","join","somethingChanged","printChangeFlags","newProps","key","_activeUpdateTrigger","updateModuleSettings","getOldProps","attributeManagerNeedsRedraw","_modelNeedsRedraw","modelNeedsRedraw","_getAttributeManager","stats","addInstanced","UNSIGNED_BYTE","onAsyncPropUpdated","_onAsyncPropUpdated","bind","setAsyncProps","_transferState","oldLayer","component","userData","propName","_checkRequiredProp","propertyName","condition","Math","pow","setUniforms","uniformMap","is64bitEnabled"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable react/no-direct-mutation-state */\n/* global fetch */\n/* global window */\nimport {COORDINATE_SYSTEM} from './constants';\nimport AttributeManager from './attribute-manager';\nimport {removeLayerInSeer} from './seer-integration';\nimport {diffProps} from '../lifecycle/props';\nimport {count} from '../utils/count';\nimport log from '../utils/log';\nimport GL from 'luma.gl/constants';\nimport {withParameters} from 'luma.gl';\nimport assert from '../utils/assert';\n\nimport Component from '../lifecycle/component';\nimport LayerState from './layer-state';\n\nconst LOG_PRIORITY_UPDATE = 1;\n\nconst EMPTY_ARRAY = Object.freeze([]);\nconst noop = () => {};\n\nconst defaultProps = {\n  // data: Special handling for null, see below\n  data: {type: 'data', value: EMPTY_ARRAY, async: true},\n  dataComparator: null,\n  dataTransform: data => data,\n  fetch: url => fetch(url).then(response => response.json()),\n  updateTriggers: {}, // Update triggers: a core change detection mechanism in deck.gl\n  numInstances: undefined,\n\n  visible: true,\n  pickable: false,\n  opacity: {type: 'number', min: 0, max: 1, value: 0.8},\n\n  onHover: noop,\n  onClick: noop,\n\n  coordinateSystem: COORDINATE_SYSTEM.LNGLAT,\n  coordinateOrigin: [0, 0, 0],\n  wrapLongitude: false,\n\n  parameters: {},\n  uniforms: {},\n  framebuffer: null,\n\n  animation: null, // Passed prop animation functions to evaluate props\n\n  // Offset depth based on layer index to avoid z-fighting.\n  // Negative values pull layer towards the camera\n  // https://www.opengl.org/archives/resources/faq/technical/polygonoffset.htm\n  getPolygonOffset: ({layerIndex}) => [0, -layerIndex * 100],\n\n  // Selection/Highlighting\n  highlightedObjectIndex: null,\n  autoHighlight: false,\n  highlightColor: [0, 0, 128, 128]\n};\n\nexport default class Layer extends Component {\n  toString() {\n    const className = this.constructor.layerName || this.constructor.name;\n    return `${className}({id: '${this.props.id}'})`;\n  }\n\n  // Public API\n\n  // Updates selected state members and marks the object for redraw\n  setState(updateObject) {\n    this.setChangeFlags({stateChanged: true});\n    Object.assign(this.state, updateObject);\n    this.setNeedsRedraw();\n  }\n\n  // Sets the redraw flag for this layer, will trigger a redraw next animation frame\n  setNeedsRedraw(redraw = true) {\n    if (this.internalState) {\n      this.internalState.needsRedraw = redraw;\n    }\n  }\n\n  // This layer needs a deep update\n  // TODO - Need to align with existing needsUpdate before uncommenting\n  // For now async props will call layerManager directly\n  setLayerNeedsUpdate() {\n    this.context.layerManager.setNeedsUpdate(String(this));\n  }\n\n  // Checks state of attributes and model\n  getNeedsRedraw({clearRedrawFlags = false} = {}) {\n    return this._getNeedsRedraw(clearRedrawFlags);\n  }\n\n  // Checks if layer attributes needs updating\n  needsUpdate() {\n    // Call subclass lifecycle method\n    return this.shouldUpdateState(this._getUpdateParams());\n    // End lifecycle method\n  }\n\n  // Returns true if the layer is pickable and visible.\n  isPickable() {\n    return this.props.pickable && this.props.visible;\n  }\n\n  // Return an array of models used by this layer, can be overriden by layer subclass\n  getModels() {\n    return this.state && (this.state.models || (this.state.model ? [this.state.model] : []));\n  }\n\n  // TODO - Gradually phase out, does not support multi model layers\n  getSingleModel() {\n    return this.state && this.state.model;\n  }\n\n  getAttributeManager() {\n    return this.internalState && this.internalState.attributeManager;\n  }\n\n  // Returns the most recent layer that matched to this state\n  // (When reacting to an async event, this layer may no longer be the latest)\n  getCurrentLayer() {\n    return this.internalState && this.internalState.layer;\n  }\n\n  // Use iteration (the only required capability on data) to get first element\n  // deprecated since we are effectively only supporting Arrays\n  getFirstObject() {\n    const {data} = this.props;\n    for (const object of data) {\n      return object;\n    }\n    return null;\n  }\n\n  // PROJECTION METHODS\n\n  // Projects a point with current map state (lat, lon, zoom, pitch, bearing)\n  // TODO - need to be extended to work with COORDINATE_SYSTEM.METERS,IDENTITY\n  // TODO - need to be extended to work with multiple `views`\n  project(lngLat) {\n    const {viewport} = this.context;\n    assert(Array.isArray(lngLat));\n    return viewport.project(lngLat);\n  }\n\n  unproject(xy) {\n    const {viewport} = this.context;\n    assert(Array.isArray(xy));\n    return viewport.unproject(xy);\n  }\n\n  projectFlat(lngLat) {\n    const {viewport} = this.context;\n    assert(Array.isArray(lngLat));\n    return viewport.projectFlat(lngLat);\n  }\n\n  unprojectFlat(xy) {\n    const {viewport} = this.context;\n    assert(Array.isArray(xy));\n    return viewport.unprojectFlat(xy);\n  }\n\n  use64bitProjection() {\n    if (this.props.fp64) {\n      if (this.props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT) {\n        return true;\n      }\n      log.once(\n        0,\n        `64-bit mode only works with coordinateSystem set to\n        COORDINATE_SYSTEM.LNGLAT. Rendering in 32-bit mode instead`\n      );\n    }\n\n    return false;\n  }\n\n  use64bitPositions() {\n    return this.props.fp64 || this.props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT_EXPERIMENTAL;\n  }\n\n  // TODO - needs to refer to context for devicePixels setting\n  screenToDevicePixels(screenPixels) {\n    log.deprecated('screenToDevicePixels', 'DeckGL prop useDevicePixels for conversion')();\n    const devicePixelRatio = typeof window !== 'undefined' ? window.devicePixelRatio : 1;\n    return screenPixels * devicePixelRatio;\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  // @return {Array} - a black color\n  nullPickingColor() {\n    return [0, 0, 0];\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  encodePickingColor(i) {\n    assert((((i + 1) >> 24) & 255) === 0, 'index out of picking color range');\n    return [(i + 1) & 255, ((i + 1) >> 8) & 255, (((i + 1) >> 8) >> 8) & 255];\n  }\n\n  // Returns the index corresponding to a picking color that doesn't match any subfeature\n  // @param {Uint8Array} color - color array to be decoded\n  // @return {Array} - the decoded picking color\n  decodePickingColor(color) {\n    assert(color instanceof Uint8Array);\n    const [i1, i2, i3] = color;\n    // 1 was added to seperate from no selection\n    const index = i1 + i2 * 256 + i3 * 65536 - 1;\n    return index;\n  }\n\n  // //////////////////////////////////////////////////\n  // LIFECYCLE METHODS, overridden by the layer subclasses\n\n  // Called once to set up the initial state\n  // App can create WebGL resources\n  initializeState() {\n    throw new Error(`Layer ${this} has not defined initializeState`);\n  }\n\n  // Let's layer control if updateState should be called\n  shouldUpdateState({oldProps, props, context, changeFlags}) {\n    return changeFlags.propsOrDataChanged;\n  }\n\n  // Default implementation, all attributes will be invalidated and updated\n  // when data changes\n  updateState({oldProps, props, context, changeFlags}) {\n    const attributeManager = this.getAttributeManager();\n    if (changeFlags.dataChanged && attributeManager) {\n      attributeManager.invalidateAll();\n    }\n  }\n\n  // Called once when layer is no longer matched and state will be discarded\n  // App can destroy WebGL resources here\n  finalizeState() {\n    for (const model of this.getModels()) {\n      model.delete();\n    }\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.finalize();\n    }\n  }\n\n  // If state has a model, draw it with supplied uniforms\n  draw(opts) {\n    for (const model of this.getModels()) {\n      model.draw(opts);\n    }\n  }\n\n  // called to populate the info object that is passed to the event handler\n  // @return null to cancel event\n  getPickingInfo({info, mode}) {\n    const {index} = info;\n\n    if (index >= 0) {\n      // If props.data is an indexable array, get the object\n      if (Array.isArray(this.props.data)) {\n        info.object = this.props.data[index];\n      }\n    }\n\n    return info;\n  }\n\n  // END LIFECYCLE METHODS\n  // //////////////////////////////////////////////////\n\n  // INTERNAL METHODS\n\n  // Default implementation of attribute invalidation, can be redefined\n  invalidateAttribute(name = 'all', diffReason = '') {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    if (name === 'all') {\n      log.log(LOG_PRIORITY_UPDATE, `updateTriggers invalidating all attributes: ${diffReason}`)();\n      attributeManager.invalidateAll();\n    } else {\n      log.log(\n        LOG_PRIORITY_UPDATE,\n        `updateTriggers invalidating attribute ${name}: ${diffReason}`\n      )();\n      attributeManager.invalidate(name);\n    }\n  }\n\n  // Calls attribute manager to update any WebGL attributes\n  updateAttributes(props) {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    // Figure out data length\n    const numInstances = this.getNumInstances(props);\n\n    attributeManager.update({\n      data: props.data,\n      numInstances,\n      props,\n      transitions: props.transitions,\n      buffers: props,\n      context: this,\n      // Don't worry about non-attribute props\n      ignoreUnknownAttributes: true\n    });\n\n    const model = this.getSingleModel();\n    if (model) {\n      const changedAttributes = attributeManager.getChangedAttributes({clearChangedFlags: true});\n      model.setAttributes(changedAttributes);\n    }\n  }\n\n  // Update attribute transition\n  updateTransition() {\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.updateTransition();\n    }\n  }\n\n  calculateInstancePickingColors(attribute, {numInstances}) {\n    const {value, size} = attribute;\n    // add 1 to index to seperate from no selection\n    for (let i = 0; i < numInstances; i++) {\n      const pickingColor = this.encodePickingColor(i);\n      value[i * size + 0] = pickingColor[0];\n      value[i * size + 1] = pickingColor[1];\n      value[i * size + 2] = pickingColor[2];\n    }\n  }\n\n  // Sets the specified instanced picking color to null picking color. Used for multi picking.\n  _clearInstancePickingColor(color) {\n    const {instancePickingColors} = this.getAttributeManager().attributes;\n    const {state: attribute} = instancePickingColors;\n    const {value, size} = attribute;\n\n    const i = this.decodePickingColor(color);\n    value[i * size + 0] = 0;\n    value[i * size + 1] = 0;\n    value[i * size + 2] = 0;\n\n    // TODO: Optimize this to use sub-buffer update!\n    const models = this.getModels();\n    if (models) {\n      models.forEach(model => model.setAttributes({instancePickingColors: attribute}));\n    }\n  }\n\n  // Sets all occurrences of the specified picking color to null picking color. Used for multi picking.\n  _clearPickingColor(color) {\n    const {pickingColors} = this.getAttributeManager().attributes;\n    const attribute = pickingColors.state;\n    const {value} = attribute;\n\n    for (let i = 0; i < value.length; i += 3) {\n      if (value[i + 0] === color[0] && value[i + 1] === color[1] && value[i + 2] === color[2]) {\n        value[i + 0] = 0;\n        value[i + 1] = 0;\n        value[i + 2] = 0;\n      }\n    }\n\n    // TODO: Optimize this to use sub-buffer update!\n    const models = this.getModels();\n    if (models) {\n      models.forEach(model => model.setAttributes({pickingColors: attribute}));\n    }\n  }\n\n  // This method figures out if we use instance colors or not\n  // and calls _clearInstancePickingColor or _clearPickingColor\n  clearPickingColor(color) {\n    if (this.getAttributeManager().attributes.pickingColors) {\n      this._clearPickingColor(color);\n    } else {\n      this._clearInstancePickingColor(color);\n    }\n  }\n\n  copyPickingColors() {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n\n    return new Uint8ClampedArray(colors.value);\n  }\n\n  restorePickingColors(value) {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n\n    colors.value.set(value);\n    colors.setNeedsUpdate();\n    this.updateAttributes(this.props);\n  }\n\n  // Deduces numer of instances. Intention is to support:\n  // - Explicit setting of numInstances\n  // - Auto-deduction for ES6 containers that define a size member\n  // - Auto-deduction for Classic Arrays via the built-in length attribute\n  // - Auto-deduction via arrays\n  getNumInstances(props) {\n    props = props || this.props;\n\n    // First check if the layer has set its own value\n    if (this.state && this.state.numInstances !== undefined) {\n      return this.state.numInstances;\n    }\n\n    // Check if app has provided an explicit value\n    if (props.numInstances !== undefined) {\n      return props.numInstances;\n    }\n\n    // Use container library to get a count for any ES6 container or object\n    const {data} = this.props;\n    return count(data);\n  }\n\n  // LAYER MANAGER API\n  // Should only be called by the deck.gl LayerManager class\n\n  // Called by layer manager when a new layer is found\n  /* eslint-disable max-statements */\n  _initialize() {\n    assert(this.context.gl);\n\n    this._initState();\n\n    // Call subclass lifecycle methods\n    this.initializeState(this.context);\n    // End subclass lifecycle methods\n\n    // TODO deprecated, for backwards compatibility with older layers\n    // in case layer resets state\n    this.state.attributeManager = this.getAttributeManager();\n\n    // initializeState callback tends to clear state\n    this.setChangeFlags({dataChanged: true, propsChanged: true, viewportChanged: true});\n\n    this._updateState();\n\n    const model = this.getSingleModel();\n    if (model) {\n      model.id = this.props.id;\n      model.program.id = `${this.props.id}-program`;\n      model.geometry.id = `${this.props.id}-geometry`;\n    }\n  }\n\n  // Called by layer manager\n  // if this layer is new (not matched with an existing layer) oldProps will be empty object\n  _update() {\n    // Call subclass lifecycle method\n    const stateNeedsUpdate = this.needsUpdate();\n    // End lifecycle method\n\n    if (stateNeedsUpdate) {\n      this._updateState();\n    }\n  }\n  /* eslint-enable max-statements */\n\n  // Common code for _initialize and _update\n  _updateState() {\n    const updateParams = this._getUpdateParams();\n\n    // Call subclass lifecycle methods\n    this.updateState(updateParams);\n\n    // Render or update previously rendered sublayers\n    if (this.isComposite) {\n      this._renderLayers(updateParams);\n    }\n    // End subclass lifecycle methods\n\n    // Add any subclass attributes\n    this.updateAttributes(this.props);\n    this._updateBaseUniforms();\n\n    // Note: Automatic instance count update only works for single layers\n    if (this.state.model) {\n      this.state.model.setInstanceCount(this.getNumInstances());\n    }\n\n    this.clearChangeFlags();\n    this.internalState.resetOldProps();\n  }\n\n  // Called by manager when layer is about to be disposed\n  // Note: not guaranteed to be called on application shutdown\n  _finalize() {\n    assert(this.internalState && this.state);\n\n    // Call subclass lifecycle method\n    this.finalizeState(this.context);\n    // End lifecycle method\n    removeLayerInSeer(this.id);\n  }\n\n  // Calculates uniforms\n  drawLayer({moduleParameters = null, uniforms = {}, parameters = {}}) {\n    if (!uniforms.picking_uActive) {\n      this.updateTransition();\n    }\n\n    // TODO/ib - hack move to luma Model.draw\n    if (moduleParameters) {\n      this.setModuleParameters(moduleParameters);\n    }\n\n    // Hack/ib - define a public luma function\n    const {animationProps} = this.context;\n    if (animationProps) {\n      for (const model of this.getModels()) {\n        model._setAnimationProps(animationProps);\n      }\n    }\n\n    // Apply polygon offset to avoid z-fighting\n    // TODO - move to draw-layers\n    const {getPolygonOffset} = this.props;\n    const offsets = (getPolygonOffset && getPolygonOffset(uniforms)) || [0, 0];\n    parameters.polygonOffset = offsets;\n\n    // Call subclass lifecycle method\n    withParameters(this.context.gl, parameters, () => {\n      this.draw({moduleParameters, uniforms, parameters, context: this.context});\n    });\n    // End lifecycle method\n  }\n\n  // {uniforms = {}, ...opts}\n  pickLayer(opts) {\n    // Call subclass lifecycle method\n    return this.getPickingInfo(opts);\n    // End lifecycle method\n  }\n\n  // Helper methods\n  getChangeFlags() {\n    return this.internalState.changeFlags;\n  }\n\n  // Dirty some change flags, will be handled by updateLayer\n  /* eslint-disable complexity */\n  setChangeFlags(flags) {\n    this.internalState.changeFlags = this.internalState.changeFlags || {};\n    const changeFlags = this.internalState.changeFlags;\n\n    // Update primary flags\n    if (flags.dataChanged && !changeFlags.dataChanged) {\n      changeFlags.dataChanged = flags.dataChanged;\n      log.log(LOG_PRIORITY_UPDATE + 1, () => `dataChanged: ${flags.dataChanged} in ${this.id}`)();\n    }\n    if (flags.updateTriggersChanged && !changeFlags.updateTriggersChanged) {\n      changeFlags.updateTriggersChanged =\n        changeFlags.updateTriggersChanged && flags.updateTriggersChanged\n          ? Object.assign({}, flags.updateTriggersChanged, changeFlags.updateTriggersChanged)\n          : flags.updateTriggersChanged || changeFlags.updateTriggersChanged;\n      log.log(\n        LOG_PRIORITY_UPDATE + 1,\n        () =>\n          'updateTriggersChanged: ' +\n          `${Object.keys(flags.updateTriggersChanged).join(', ')} in ${this.id}`\n      )();\n    }\n    if (flags.propsChanged && !changeFlags.propsChanged) {\n      changeFlags.propsChanged = flags.propsChanged;\n      log.log(LOG_PRIORITY_UPDATE + 1, () => `propsChanged: ${flags.propsChanged} in ${this.id}`)();\n    }\n    if (flags.viewportChanged && !changeFlags.viewportChanged) {\n      changeFlags.viewportChanged = flags.viewportChanged;\n      log.log(\n        LOG_PRIORITY_UPDATE + 2,\n        () => `viewportChanged: ${flags.viewportChanged} in ${this.id}`\n      )();\n    }\n    if (flags.stateChanged && !changeFlags.stateChanged) {\n      changeFlags.stateChanged = flags.stateChanged;\n      log.log(LOG_PRIORITY_UPDATE + 1, () => `stateChanged: ${flags.stateChanged} in ${this.id}`)();\n    }\n\n    // Update composite flags\n    const propsOrDataChanged =\n      flags.dataChanged || flags.updateTriggersChanged || flags.propsChanged;\n    changeFlags.propsOrDataChanged = changeFlags.propsOrDataChanged || propsOrDataChanged;\n    changeFlags.somethingChanged =\n      changeFlags.somethingChanged ||\n      propsOrDataChanged ||\n      flags.viewportChanged ||\n      flags.stateChanged;\n  }\n  /* eslint-enable complexity */\n\n  // Clear all changeFlags, typically after an update\n  clearChangeFlags() {\n    this.internalState.changeFlags = {\n      // Primary changeFlags, can be strings stating reason for change\n      dataChanged: false,\n      propsChanged: false,\n      updateTriggersChanged: false,\n      viewportChanged: false,\n      stateChanged: false,\n\n      // Derived changeFlags\n      propsOrDataChanged: false,\n      somethingChanged: false\n    };\n  }\n\n  printChangeFlags() {\n    const flags = this.internalState.changeFlags;\n    return `\\\n${flags.dataChanged ? 'data ' : ''}\\\n${flags.propsChanged ? 'props ' : ''}\\\n${flags.updateTriggersChanged ? 'triggers ' : ''}\\\n${flags.viewportChanged ? 'viewport' : ''}\\\n`;\n  }\n\n  // Compares the layers props with old props from a matched older layer\n  // and extracts change flags that describe what has change so that state\n  // can be update correctly with minimal effort\n  diffProps(newProps, oldProps) {\n    const changeFlags = diffProps(newProps, oldProps);\n\n    // iterate over changedTriggers\n    if (changeFlags.updateTriggersChanged) {\n      for (const key in changeFlags.updateTriggersChanged) {\n        if (changeFlags.updateTriggersChanged[key]) {\n          this._activeUpdateTrigger(key);\n        }\n      }\n    }\n\n    return this.setChangeFlags(changeFlags);\n  }\n\n  setModuleParameters(moduleParameters) {\n    for (const model of this.getModels()) {\n      model.updateModuleSettings(moduleParameters);\n    }\n  }\n\n  // PRIVATE METHODS\n\n  _getUpdateParams() {\n    return {\n      props: this.props,\n      oldProps: this.internalState.getOldProps(),\n      context: this.context,\n      changeFlags: this.internalState.changeFlags\n    };\n  }\n\n  // Checks state of attributes and model\n  _getNeedsRedraw(clearRedrawFlags) {\n    // this method may be called by the render loop as soon a the layer\n    // has been created, so guard against uninitialized state\n    if (!this.internalState) {\n      return false;\n    }\n\n    let redraw = false;\n    redraw = redraw || (this.internalState.needsRedraw && this.id);\n    this.internalState.needsRedraw = this.internalState.needsRedraw && !clearRedrawFlags;\n\n    // TODO - is attribute manager needed? - Model should be enough.\n    const attributeManager = this.getAttributeManager();\n    const attributeManagerNeedsRedraw =\n      attributeManager && attributeManager.getNeedsRedraw({clearRedrawFlags});\n    redraw = redraw || attributeManagerNeedsRedraw;\n\n    redraw = redraw || this._modelNeedsRedraw(clearRedrawFlags);\n\n    return redraw;\n  }\n\n  _modelNeedsRedraw(clearRedrawFlags) {\n    let redraw = false;\n\n    for (const model of this.getModels()) {\n      let modelNeedsRedraw = model.getNeedsRedraw({clearRedrawFlags});\n      if (modelNeedsRedraw && typeof modelNeedsRedraw !== 'string') {\n        modelNeedsRedraw = `model ${model.id}`;\n      }\n      redraw = redraw || modelNeedsRedraw;\n    }\n\n    return redraw;\n  }\n\n  // Create new attribute manager\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats\n    });\n  }\n\n  _initState() {\n    assert(!this.internalState && !this.state);\n\n    const attributeManager = this._getAttributeManager();\n\n    if (attributeManager) {\n      // All instanced layers get instancePickingColors attribute by default\n      // Their shaders can use it to render a picking scene\n      // TODO - this slightly slows down non instanced layers\n      attributeManager.addInstanced({\n        instancePickingColors: {\n          type: GL.UNSIGNED_BYTE,\n          size: 3,\n          update: this.calculateInstancePickingColors\n        }\n      });\n    }\n\n    this.internalState = new LayerState({\n      attributeManager,\n      layer: this\n    });\n\n    this.state = {};\n    // TODO deprecated, for backwards compatibility with older layers\n    this.state.attributeManager = attributeManager;\n\n    this.internalState.onAsyncPropUpdated = this._onAsyncPropUpdated.bind(this);\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n  }\n\n  // Called by layer manager to transfer state from an old layer\n  _transferState(oldLayer) {\n    const {state, internalState} = oldLayer;\n    assert(state && internalState);\n\n    if (this === oldLayer) {\n      return;\n    }\n\n    // Move internalState\n    this.internalState = internalState;\n    this.internalState.component = this;\n\n    // Move state\n    this.state = state;\n    // Deprecated: layer references on `state`\n    state.layer = this;\n    // We keep the state ref on old layers to support async actions\n    // oldLayer.state = null;\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n\n    // Update model layer reference\n    for (const model of this.getModels()) {\n      model.userData.layer = this;\n    }\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n\n    this.diffProps(this.props, this.internalState.getOldProps());\n  }\n\n  _onAsyncPropUpdated() {\n    this.diffProps(this.props, this.internalState.getOldProps());\n    this.setLayerNeedsUpdate();\n  }\n\n  // Operate on each changed triggers, will be called when an updateTrigger changes\n  _activeUpdateTrigger(propName) {\n    this.invalidateAttribute(propName);\n  }\n\n  //  Helper to check that required props are supplied\n  _checkRequiredProp(propertyName, condition) {\n    const value = this.props[propertyName];\n    if (value === undefined) {\n      throw new Error(`Property ${propertyName} undefined in layer ${this}`);\n    }\n    if (condition && !condition(value)) {\n      throw new Error(`Bad property ${propertyName} in layer ${this}`);\n    }\n  }\n\n  _updateBaseUniforms() {\n    const uniforms = {\n      // apply gamma to opacity to make it visually \"linear\"\n      opacity:\n        typeof this.props.opacity === 'function'\n          ? animationProps => Math.pow(this.props.opacity(animationProps), 1 / 2.2)\n          : Math.pow(this.props.opacity, 1 / 2.2)\n    };\n    for (const model of this.getModels()) {\n      model.setUniforms(uniforms);\n    }\n\n    // TODO - set needsRedraw on the model(s)?\n    this.setNeedsRedraw();\n  }\n\n  // DEPRECATED METHODS\n\n  // Updates selected state members and marks the object for redraw\n  setUniforms(uniformMap) {\n    for (const model of this.getModels()) {\n      model.setUniforms(uniformMap);\n    }\n\n    // TODO - set needsRedraw on the model(s)?\n    this.setNeedsRedraw();\n    log.deprecated('layer.setUniforms', 'model.setUniforms')();\n  }\n\n  is64bitEnabled() {\n    log.deprecated('is64bitEnabled', 'use64bitProjection')();\n    return this.use64bitProjection();\n  }\n}\n\nLayer.layerName = 'Layer';\nLayer.defaultProps = defaultProps;\n"],"file":"layer.js"}